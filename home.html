<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>모바일 성경 퀴즈 (한국어) — 120문항</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{height:100%}
    body{background:linear-gradient(180deg,#f8fafc,#eef2ff);-webkit-font-smoothing:antialiased}
    .app{max-width:720px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;padding:16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 28px rgba(12,35,89,.06)}
    .opt-btn{padding-top:14px;padding-bottom:14px}
    .explain{background:#fff;border-left:4px solid #0ea5e9;padding:12px;border-radius:8px}
    .chip{border-radius:9999px;padding:.25rem .6rem;border:1px solid #e5e7eb;font-size:.75rem}
  </style>
</head>
<body>
<div class="app">
  <header class="mb-4">
    <div class="card p-4">
      <h1 class="text-2xl font-semibold text-center">모바일 성경 퀴즈 (한국어)</h1>
      <p class="text-sm text-center text-gray-600 mt-1">사무엘상 · 사무엘하 · 에베소서 · 빌립보서 · 골로세서 · 빌레몬서 (각 20문항)</p>
      <p class="text-xs text-center text-gray-500">오답 노트, 진행 저장(쿠키/로컬스토리지), 난이도 필터, 장/서론 포함</p>
    </div>
  </header>

  <main class="flex-1">
    <!-- 선택 섹션 -->
    <section class="card p-4 mb-4" id="selector">
      <div class="grid grid-cols-1 gap-3">
        <label class="block text-sm font-medium text-gray-700">책 선택</label>
        <select id="bookSelect" class="w-full rounded-lg border-gray-200 shadow-sm p-3">
          <option value="">— 선택 —</option>
          <option value="1sam">사무엘상</option>
          <option value="2sam">사무엘하</option>
          <option value="eph">에베소서</option>
          <option value="phil">빌립보서</option>
          <option value="col">골로세서</option>
          <option value="phm">빌레몬서</option>
        </select>

        <div class="grid grid-cols-2 gap-2 mt-2">
          <div>
            <label class="block text-sm font-medium text-gray-700">난이도</label>
            <select id="diffSelect" class="w-full rounded-lg border-gray-200 shadow-sm p-3">
              <option value="all">전체</option>
              <option value="easy">쉬움</option>
              <option value="medium">보통</option>
              <option value="hard">어려움</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">출제 모드</label>
            <select id="modeSelect" class="w-full rounded-lg border-gray-200 shadow-sm p-3">
              <option value="normal">전체 문제</option>
              <option value="wrongonly">오답 노트만</option>
            </select>
          </div>
        </div>

        <div class="flex gap-2 mt-3">
          <button id="startBtn" class="flex-1 bg-blue-600 text-white rounded-lg py-3 font-semibold">시작</button>
          <button id="resumeBtn" class="flex-1 bg-white border border-gray-200 text-gray-700 rounded-lg py-3">이어하기(쿠키)</button>
        </div>
      </div>
    </section>

    <!-- 서론 -->
    <section class="card p-4 mb-4 hidden" id="intro">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold" id="introTitle">서론</h2>
        <span id="introMeta" class="chip text-gray-600"></span>
      </div>
      <div class="text-sm text-gray-800" id="introBody"></div>
    </section>

    <!-- 퀴즈 영역 -->
    <section id="quizArea" class="hidden card p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="text-sm text-gray-600" id="bookTitle"></div>
        <div class="text-sm text-gray-600 flex items-center gap-2">
          <span id="progress">0 / 0</span>
          <span id="diffPill" class="chip text-blue-700 bg-blue-50 border-blue-200">전체</span>
        </div>
      </div>

      <div id="qCard" class="mb-3"></div>
      <div id="explainBox" class="hidden mb-4 explain text-sm text-gray-700"></div>

      <div class="flex gap-2">
        <button id="nextBtn" class="flex-1 bg-green-600 text-white rounded-lg py-3 font-semibold" disabled>다음</button>
        <button id="quitBtn" class="flex-1 bg-red-50 text-red-600 rounded-lg py-3 border border-red-100">종료</button>
      </div>
    </section>

    <!-- 결과 -->
    <section id="resultArea" class="hidden card p-4 mt-4">
      <div class="text-center mb-3">
        <div class="text-lg font-bold" id="finalScore"></div>
        <div class="text-sm text-gray-600" id="finalMsg"></div>
      </div>
      <div class="grid grid-cols-1 gap-2">
        <button id="reviewBtn" class="w-full bg-blue-600 text-white rounded-lg py-3">정답/해설 보기</button>
        <button id="restartBtn" class="w-full bg-white border border-gray-200 rounded-lg py-3">다시 시작</button>
      </div>
    </section>

    <!-- 리뷰 -->
    <section id="reviewArea" class="hidden card p-4 mt-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">정답 및 해설</h3>
        <button id="exportWrongBtn" class="chip bg-yellow-50 border-yellow-200 text-yellow-700">오답 노트 내보내기</button>
      </div>
      <div id="reviewList" class="space-y-3 max-h-[52vh] overflow-auto pr-2"></div>
      <div class="mt-3 grid grid-cols-1 gap-2">
        <button id="closeReviewBtn" class="w-full bg-gray-100 rounded-lg py-3">닫기</button>
        <button id="retryWrongBtn" class="w-full bg-orange-600 text-white rounded-lg py-3">오답만 다시풀기</button>
        <button id="clearWrongBtn" class="w-full bg-white border border-gray-200 rounded-lg py-3">오답 노트 비우기</button>
      </div>
    </section>
  </main>

  <footer class="mt-4 text-center text-xs text-gray-500">
    오프라인에서도 동작. 진행상황은 쿠키/로컬스토리지에 저장됩니다.
  </footer>
</div>

<script>
/********************
 * 서론 데이터
 ********************/
const bookIntros = {
  '1sam': {
    title: '사무엘상',
    meta: '저자(전통): 사무엘·나단·갓 | 시기: BC 11세기 후반',
    background: '사사 시대에서 왕정으로 전환되는 분수령. 사무엘의 등장, 사울의 왕위, 다윗의 부상.',
    summary: '한나의 기도와 사무엘 출생, 백성의 왕 요구, 사울의 실족과 버림, 다윗의 기름부음과 골리앗 격파, 사울의 시기와 추격.',
    characters: [
      {name:'사무엘', note:'선지자/제사장, 사울·다윗에게 기름 부음.'},
      {name:'사울', note:'이스라엘 첫 왕. 불순종으로 버림받음.'},
      {name:'다윗', note:'목동 출신. 골리앗을 물리치고 차기 왕으로 부상.'},
      {name:'한나', note:'사무엘의 어머니. 모범적 기도자.'},
      {name:'요나단', note:'사울의 아들. 다윗의 충성된 친구.'}
    ]
  },
  '2sam': {
    title: '사무엘하',
    meta: '저자(전통): 나단·갓 | 시기: BC 10세기 초',
    background: '다윗의 통치기: 승리와 확장, 도덕적 실패와 가족 비극, 회개와 회복.',
    summary: '다윗의 즉위, 예루살렘 정복과 언약궤, 밧세바 사건과 회개, 압살롬 반역, 인구조사로 인한 재앙과 마무리.',
    characters: [
      {name:'다윗', note:'이스라엘 왕. 시인·전사·회개자.'},
      {name:'나단', note:'다윗을 책망한 선지자.'},
      {name:'요압', note:'다윗의 장군. 유능하지만 강경함.'},
      {name:'압살롬', note:'다윗의 아들. 반역 주도.'},
      {name:'밧세바', note:'우리야의 아내, 후에 다윗의 아내.'}
    ]
  },
  'eph': {
    title: '에베소서',
    meta: '저자: 바울 | 시기: AD 60–62(로마 구금 중 추정)',
    background: '교회의 정체성과 연합, 유대인·이방인의 하나 됨, 성도의 성숙과 영적 전쟁.',
    summary: '1–3장은 그리스도 안의 신령한 복과 교회의 비밀, 4–6장은 성도의 삶(연합·성숙·가정규범·하나님의 전신갑주).',
    characters: [
      {name:'바울', note:'사도, 서신 저자.'},
      {name:'에베소 성도', note:'주로 이방인 배경. 교회 일치와 성숙 권면.'}
    ]
  },
  'phil': {
    title: '빌립보서',
    meta: '저자: 바울 | 시기: AD 60–62(로마 구금 중 추정)',
    background: '복음 동역 공동체 빌립보 교회에 보낸 따뜻한 격려의 편지.',
    summary: '기쁨, 겸손(그리스도 찬가), 복음 진보, 어떤 형편에도 자족, 감사와 기도로 염려 극복.',
    characters: [
      {name:'바울', note:'옥중에서도 기쁨을 권면.'},
      {name:'디모데', note:'신뢰받는 후계 동역자.'},
      {name:'에바브로디도', note:'바울을 섬긴 사자(메신저).'}
    ]
  },
  'col': {
    title: '골로세서',
    meta: '저자: 바울 | 시기: AD 60–62(로마 구금 중 추정)',
    background: '그리스도의 우월성과 충만을 강조하여 혼합주의·율법주의·천사숭배 등 허탄한 철학을 경계.',
    summary: '그리스도의 탁월성과 교회의 머리 되심, 옛 사람 벗고 새 사람 입음, 가정·사회 윤리, 기도와 지혜로운 행실.',
    characters: [
      {name:'바울', note:'그리스도의 충만·주권을 옹호.'},
      {name:'에바브라', note:'골로새 교회의 설립/헌신자.'},
      {name:'골로새 성도', note:'헛된 철학을 경계할 대상.'}
    ]
  },
  'phm': {
    title: '빌레몬서',
    meta: '저자: 바울 | 시기: AD 60–62(로마 구금 중 추정)',
    background: '도망 종 오네시모와 주인 빌레몬 사이의 화해를 위한 개인 서신.',
    summary: '오네시모를 종이 아닌 사랑받는 형제로 받으라는 바울의 사랑의 간청. 복음이 관계를 새롭게 함.',
    characters: [
      {name:'빌레몬', note:'수신자. 신실한 가정 교회 리더.'},
      {name:'오네시모', note:'도망 종. 회심 후 유익한 동역자.'},
      {name:'바울', note:'중재자. 사랑으로 설득.'}
    ]
  }
};

/*************************
 * 문제 데이터 (각 20문) 
 * {question, options[4], answer(인덱스), explain, difficulty: '쉬움'|'보통'|'어려움'}
 *************************/
const booksData = {
  '1sam': {
    title:'사무엘상',
    questions:[
      {question:'사무엘의 어머니는 누구인가?',options:['미리암','한나','나오미','룻'],answer:1,explain:'한나는 서원 기도로 사무엘을 낳고 여호와께 드렸습니다(삼상 1).',difficulty:'쉬움'},
      {question:'사무엘이 섬기던 제사장은?',options:['아론','엘리','사독','스가랴'],answer:1,explain:'사무엘은 엘리 제사장 아래서 자랐습니다(삼상 2–3).',difficulty:'쉬움'},
      {question:'사무엘이 처음 여호와의 부르심에 응답할 때 배운 말은?',options:['내가 여기 있나이다','말씀 없어서','네 종이 듣나이다','주여 긍휼'],answer:2,explain:'엘리의 조언으로 “말씀하옵소서, 주의 종이 듣나이다”라고 응답합니다(삼상 3:10).',difficulty:'쉬움'},
      {question:'이스라엘의 첫 왕은 누구인가?',options:['다윗','사울','솔로몬','여로보암'],answer:1,explain:'이스라엘이 왕을 구하자 사울이 기름부음 받았습니다(삼상 9–10).',difficulty:'쉬움'},
      {question:'사울이 버림받은 주된 이유는?',options:['기도 부족','아말렉 진멸 불순종','군사력 약함','세금 문제'],answer:1,explain:'하나님의 명령을 어기고 아말렉과 그 짐승을 남겼습니다(삼상 15).',difficulty:'보통'},
      {question:'다윗이 골리앗을 쓰러뜨릴 때 사용한 것은?',options:['검','창','물맷돌','활'],answer:2,explain:'다윗은 물맷돌로 골리앗을 쓰러뜨렸고 칼로 마무리했습니다(삼상 17).',difficulty:'쉬움'},
      {question:'다윗의 아버지는 누구인가?',options:['오벳','이새','보아스','엘리멜렉'],answer:1,explain:'다윗은 베들레헴 사람 이새의 아들입니다(삼상 16:1).',difficulty:'쉬움'},
      {question:'다윗과 깊은 우정을 나눈 사울의 아들은?',options:['므비보셋','요나단','이스보셋','압살롬'],answer:1,explain:'요나단은 다윗과 언약을 맺고 생명을 아끼지 않았습니다(삼상 18–20).',difficulty:'쉬움'},
      {question:'사울이 다윗을 시기한 주요 이유는?',options:['왕좌 노림','백성의 찬양', '예언 때문','세금'],answer:1,explain:'“사울은 천천, 다윗은 만만” 노래로 시기가 타올랐습니다(삼상 18:7).',difficulty:'쉬움'},
      {question:'사무엘상이 시작되는 영적 분위기를 잘 나타내는 것은?',options:['말씀이 희귀함','부흥','평화','우상 타파'],answer:0,explain:'“여호와의 말씀이 희귀하여 이상이 흔히 보이지 않았다”(삼상 3:1).',difficulty:'보통'},
      {question:'블레셋과 전투 중 이스라엘이 가져온 성물은?',options:['성막','언약궤','분향단','금촛대'],answer:1,explain:'언약궤를 전장에 가져왔으나 빼앗김을 당합니다(삼상 4).',difficulty:'보통'},
      {question:'블레셋에게 빼앗긴 언약궤가 돌아온 표징과 관련 없는 것은?',options:['독종 재앙','금 독종·금 쥐','젖나는 소가 끄는 새 수레','요단강 도하'],answer:3,explain:'요단 도하는 여호수아서 사건. 언약궤는 재앙 후 새 수레로 되돌려졌습니다(삼상 5–6).',difficulty:'어려움'},
      {question:'사울이 길갈에서 범한 죄는?',options:['우상숭배','사무엘 기다리지 않고 번제 드림','제사장 살해','거짓 맹세'],answer:1,explain:'사무엘을 기다리지 않고 스스로 번제를 드렸습니다(삼상 13).',difficulty:'보통'},
      {question:'사무엘이 기름을 부어 차기 왕으로 세운 이는?',options:['다윗','요나단','아브넬','이스보셋'],answer:0,explain:'하나님은 마음을 보시고 다윗을 택하셨습니다(삼상 16).',difficulty:'쉬움'},
      {question:'나발의 사건에서 다윗을 지혜롭게 막은 사람은?',options:['미갈','아비가일','리브가','라마'],answer:1,explain:'아비가일의 중재로 피흘림을 피했습니다(삼상 25).',difficulty:'보통'},
      {question:'사울이 신접한 여인을 찾아간 곳은?',options:['엔돌','길갈','미스바','실로'],answer:0,explain:'사울은 엔돌의 신접한 여인을 찾았습니다(삼상 28).',difficulty:'보통'},
      {question:'다윗이 사울을 죽이지 않은 이유로 적절한 것은?',options:['두려워서','증거 부족','여호와의 기름부음 받은 자이기 때문','요나단의 부탁'],answer:2,explain:'하나님의 기름부음 받은 자를 해치지 않으려 했습니다(삼상 24,26).',difficulty:'보통'},
      {question:'사울이 최후를 맞은 산은?',options:['길보아 산','갈멜 산','시온 산','에발 산'],answer:0,explain:'블레셋과의 전투에서 길보아 산에서 최후를 맞습니다(삼상 31).',difficulty:'쉬움'},
      {question:'사무엘상 전체의 주제를 가장 잘 요약하는 것은?',options:['왕권의 확립과 순종의 중요성','성전 건축','율법 해석','바벨론 포로'],answer:0,explain:'왕정의 시작과 순종/불순종의 열매가 핵심입니다.',difficulty:'보통'},
      {question:'사무엘이 백성의 왕 요구에 대해 취한 첫 반응은?',options:['기뻐함','슬퍼하며 기도함','즉시 허락','거부 후 사임'],answer:1,explain:'사무엘은 기도로 하나님의 뜻을 구했습니다(삼상 8).',difficulty:'쉬움'}
    ]
  },

  '2sam': {
    title:'사무엘하',
    questions:[
      {question:'사무엘하의 중심 인물은?',options:['사울','다윗','솔로몬','사무엘'],answer:1,explain:'사무엘하는 다윗의 통치와 삶을 다룹니다.',difficulty:'쉬움'},
      {question:'다윗이 수도로 삼은 도시는?',options:['헤브론','예루살렘','여리고','사마리아'],answer:1,explain:'다윗은 예루살렘을 정복하고 수도로 삼습니다(삼하 5).',difficulty:'쉬움'},
      {question:'예루살렘으로 옮겨온 중요한 성물은?',options:['분향단','언약궤','노뱀','에봇'],answer:1,explain:'언약궤를 기쁨으로 모셔왔습니다(삼하 6).',difficulty:'쉬움'},
      {question:'다윗 언약(후손과 왕위의 약속)이 언급되는 장은?',options:['삼하 3','삼하 5','삼하 7','삼하 9'],answer:2,explain:'하나님의 은혜 언약이 삼하 7장에 나옵니다.',difficulty:'보통'},
      {question:'다윗이 밧세바와 범죄했을 때 책망한 선지자는?',options:['엘리사','사무엘','나단','가드'],answer:2,explain:'선지자 나단이 비유로 책망했고, 다윗은 회개했습니다(삼하 12).',difficulty:'쉬움'},
      {question:'밧세바의 남편은?',options:['우리야','요압','아브넬','히렘'],answer:0,explain:'헷 사람 우리야입니다(삼하 11).',difficulty:'쉬움'},
      {question:'다윗의 인구조사 결과로 임한 재앙은?',options:['지진','전염병','가뭄','포로'],answer:1,explain:'다윗의 죄로 전염병이 임했습니다(삼하 24).',difficulty:'보통'},
      {question:'다윗이 언약궤를 옮길 때 우사에게 일어난 일은?',options:['치유','죽음','축복','포로'],answer:1,explain:'우사가 궤를 붙잡자 징벌을 받아 죽었습니다(삼하 6:6-7).',difficulty:'보통'},
      {question:'므비보셋은 누구와 어떤 관계?',options:['사울의 아들이자 다윗의 적','요나단의 아들이자 다윗의 자비 대상','사독의 형제','압살롬의 아들'],answer:1,explain:'요나단의 아들이며 다윗이 은총을 베풀었습니다(삼하 9).',difficulty:'보통'},
      {question:'압살롬이 반역할 때 다윗은 어떻게 했는가?',options:['즉시 전투','예루살렘 철수','바벨론 망명','사울에게 지원 요청'],answer:1,explain:'다윗은 피난하며 상황을 수습했습니다(삼하 15).',difficulty:'보통'},
      {question:'압살롬의 최후는?',options:['유배','암살','전투 중 사망','회개 후 귀환'],answer:2,explain:'전투 중 나무에 걸려 요압에게 죽임을 당합니다(삼하 18).',difficulty:'쉬움'},
      {question:'요압의 성격을 가장 잘 설명하는 것은?',options:['온유한 중재자','유능하나 강경하고 계산적','겁많은 병사','예언자'],answer:1,explain:'요압은 왕국을 지켰으나 때로 과격했습니다.',difficulty:'보통'},
      {question:'사무엘하의 주제와 거리가 먼 것은?',options:['왕권의 확립','죄와 회개','가정의 갈등','성전 완공'],answer:3,explain:'성전 건축은 사무엘하가 아니라 후대(열왕기/역대기)와 연관됩니다.',difficulty:'어려움'},
      {question:'아비가일과 관련된 사건은 사무엘상/하 중 어디?',options:['사무엘상','사무엘하'],answer:0,explain:'아비가일은 사무엘상 25장의 사건입니다.',difficulty:'보통'},
      {question:'다윗의 장군으로 잘못된 인물은?',options:['요압','아비새','사독','브나야'],answer:2,explain:'사독은 제사장, 나머지는 군 지휘자들입니다.',difficulty:'보통'},
      {question:'다윗이 언약궤 앞에서 춤춘 이유와 관련 깊은 태도는?',options:['체면 중시','하나님 앞 겸손한 경배','정치 과시','슬픔'],answer:1,explain:'다윗은 여호와 앞에서 겸손히 기뻐했습니다(삼하 6).',difficulty:'쉬움'},
      {question:'암논과 다말 사건 이후 압살롬이 한 일은?',options:['용서','암논 살해','도망 후 귀환','제사장 임명'],answer:1,explain:'압살롬은 암논을 죽이고 도망했다가 후에 돌아옵니다(삼하 13).',difficulty:'보통'},
      {question:'아히도벨은 누구 편에 섰는가?',options:['다윗','압살롬','요압','사독'],answer:1,explain:'압살롬 편에서 계략을 내었고 후에 자결합니다(삼하 16–17).',difficulty:'어려움'},
      {question:'다윗의 말년, 아라우나의 타작마당을 산 이유는?',options:['궁전 건축','제단 쌓아 제사하려고','군수 창고','왕의 묘지'],answer:1,explain:'전염병 중 제단을 쌓아 여호와께 제사하기 위해 구매했습니다(삼하 24).',difficulty:'보통'},
      {question:'사무엘하의 결론적 교훈은?',options:['완전한 인간 왕의 필요','회개를 통한 회복의 소망','전쟁의 무용성','세금 개혁'],answer:1,explain:'죄에도 불구하고 회개와 은혜의 회복이 강조됩니다.',difficulty:'보통'}
    ]
  },

  'eph': {
    title:'에베소서',
    questions:[
      {question:'에베소서의 저자는?',options:['베드로','요한','바울','야고보'],answer:2,explain:'바울이 로마 구금 중 기록한 것으로 전승됩니다.',difficulty:'쉬움'},
      {question:'교회는 그리스도의 무엇으로 묘사되는가?',options:['군대','몸','궁전','도성'],answer:1,explain:'에베소서는 교회를 그리스도의 몸으로 강조합니다(엡 1:22–23).',difficulty:'쉬움'},
      {question:'구원은 무엇으로 받는가?',options:['행위','율법','은혜로 믿음으로','혈통'],answer:2,explain:'엡 2:8–9 “너희가 그 은혜에 의하여 믿음으로 말미암아 구원을 받았나니…”.',difficulty:'쉬움'},
      {question:'“한 주, 한 믿음, 한 세례”가 나오는 장은?',options:['2장','3장','4장','5장'],answer:2,explain:'연합과 은사를 다루는 4장에 나옵니다.',difficulty:'쉬움'},
      {question:'하나님의 전신갑주가 나오는 장은?',options:['3장','4장','5장','6장'],answer:3,explain:'영적 전쟁과 전신갑주는 6장.',difficulty:'쉬움'},
      {question:'성령의 인침은 무엇을 의미하는가?',options:['구원의 보증','방언의 증표','직분 임명','세례 재시행'],answer:0,explain:'성령의 인침은 약속의 보증(엡 1:13–14).',difficulty:'보통'},
      {question:'남편과 아내의 관계 비유는?',options:['왕과 신하','그리스도와 교회','스승과 제자','형과 아우'],answer:1,explain:'엡 5장에서 그리스도와 교회의 관계로 설명합니다.',difficulty:'쉬움'},
      {question:'교회의 일치와 성숙을 위해 주어진 것은?',options:['권력','은사와 직분','재산','혈통'],answer:1,explain:'사도·선지자·복음전하는 자·목사와 교사(엡 4:11–13).',difficulty:'보통'},
      {question:'에베소서 2장이 말하는 화해의 대상은?',options:['유대인과 사마리아인','유대인과 이방인','로마와 유대','바리새와 사두개'],answer:1,explain:'그리스도 안에서 유대인과 이방인이 하나가 됩니다.',difficulty:'보통'},
      {question:'에베소서의 구조로 적절한 것은?',options:['교리→권면','역사→시편','예언→율법','전기→잠언'],answer:0,explain:'1–3장 교리(신학), 4–6장 권면(윤리).',difficulty:'보통'},
      {question:'영적 전쟁의 상대를 어떻게 묘사하는가?',options:['혈과 육','어둠의 권세들','자연 세력','정부'],answer:1,explain:'하늘에 있는 악의 영들을 상대합니다(엡 6:12).',difficulty:'보통'},
      {question:'성령 충만의 실천 중 옳은 것은?',options:['술 취함','시와 찬미와 신령한 노래','분노 표출','불평'],answer:1,explain:'엡 5:18–20에서 찬양과 감사, 복종을 권면합니다.',difficulty:'보통'},
      {question:'새 사람을 입는 것과 관련 깊은 덕목은?',options:['탐욕','정직·온유·사랑','시기','거짓'],answer:1,explain:'옛 사람을 벗고 새 사람을 입으라(엡 4).',difficulty:'보통'},
      {question:'기도에 대한 권면으로 옳지 않은 것은?',options:['항상 깨어','모든 성도를 위해','감사함으로','외식적으로'],answer:3,explain:'기도는 성령 안에서 깨어 감사함으로 드립니다(엡 6:18).',difficulty:'쉬움'},
      {question:'에베소서의 수신자는?',options:['유대인만','이방인만','유대·이방 신자 모두','로마 군인'],answer:2,explain:'다양한 배경의 신자 공동체를 향한 서신입니다.',difficulty:'보통'},
      {question:'그리스도 안의 “신령한 복”은 어디에?',options:['땅','하늘에','성전','산'],answer:1,explain:'하늘에 속한 모든 신령한 복(엡 1:3).',difficulty:'보통'},
      {question:'분을 내어도 죄를 짓지 말라는 권면의 취지는?',options:['분노 금지','분노를 오래 품지 말라','복수 권장','침묵'],answer:1,explain:'해가 지도록 분을 품지 말라(엡 4:26).',difficulty:'보통'},
      {question:'에베소서가 “비밀”이라 부르는 핵심은?',options:['세례식 절차','성찬 규례','이방인의 동참','성전 건축'],answer:2,explain:'복음으로 이방인이 상속자 됨(엡 3).',difficulty:'어려움'},
      {question:'그리스도의 몸으로서 지체의 태도는?',options:['서로 속임','서로 용납·사랑','경쟁','무시'],answer:1,explain:'평안의 매는 줄로 성령이 하나 되게 하신 것을 힘써 지키라(엡 4:3).',difficulty:'쉬움'},
      {question:'전신갑주 중 “믿음의 방패”는 무엇을 막는가?',options:['칼과 창','악한 자의 불화살','질병','가난'],answer:1,explain:'시험과 의심의 불화살을 막는 믿음(엡 6:16).',difficulty:'쉬움'}
    ]
  },

  'phil': {
    title:'빌립보서',
    questions:[
      {question:'빌립보서의 중심 주제는?',options:['절망','기쁨','율법','형벌'],answer:1,explain:'옥중에서도 기쁨과 감사, 복음의 진보를 강조합니다.',difficulty:'쉬움'},
      {question:'바울이 빌립보서를 기록한 장소(전승)는?',options:['에베소','로마 구금','예루살렘','안디옥'],answer:1,explain:'대다수 견해가 로마 구금기(AD 60–62)로 봅니다.',difficulty:'보통'},
      {question:'그리스도의 겸손 찬가가 있는 장은?',options:['1장','2장','3장','4장'],answer:1,explain:'빌 2장: 낮아지심과 높아지심.',difficulty:'쉬움'},
      {question:'“내게 능력 주시는 자 안에서…” 구절은?',options:['1:6','2:10','4:13','3:8'],answer:2,explain:'빌 4:13.',difficulty:'쉬움'},
      {question:'바울이 권하는 염려 대처법은?',options:['참기','분노','기도와 간구로 감사함','도피'],answer:2,explain:'아무 것도 염려하지 말고 기도와 간구로 감사함(빌 4:6).',difficulty:'쉬움'},
      {question:'자족을 배웠다고 고백한 장은?',options:['1장','2장','3장','4장'],answer:3,explain:'바울은 어느 형편에든 자족하기를 배웠다고 합니다(빌 4).',difficulty:'쉬움'},
      {question:'에바브로디도는 누구인가?',options:['제사장','바울을 섬긴 사자','장군','세리'],answer:1,explain:'빌립보 교회가 보낸 사자이며 병까지 들 정도로 수고했습니다(빌 2).',difficulty:'보통'},
      {question:'바울이 칭찬하는 태도로 옳지 않은 것은?',options:['겸손','복음 협력','시기','희생적 사랑'],answer:2,explain:'시기와 다툼은 경계의 대상입니다(빌 2).',difficulty:'쉬움'},
      {question:'바울의 삶의 목표를 잘 요약한 것은?',options:['자기 영광','그리스도를 얻고 알아감','재산 축적','정치적 힘'],answer:1,explain:'그리스도를 아는 지식의 탁월함(빌 3:8).',difficulty:'보통'},
      {question:'빌립보 교회에 대한 바울의 마음은?',options:['실망','기쁨과 감사','두려움','무관심'],answer:1,explain:'그들의 동역과 후원에 감사하며 기뻐합니다.',difficulty:'쉬움'},
      {question:'빌 1장에 따르면 바울의 결박이 가져온 결과는?',options:['복음 위축','복음 진보','교회 침체','분열'],answer:1,explain:'결박으로도 오히려 복음이 진전되었습니다(빌 1:12).',difficulty:'보통'},
      {question:'빌 2장에서 본받으라 한 그리스도의 자세는?',options:['권리 주장','겸손과 순종','자기 방어','지혜 자랑'],answer:1,explain:'자기를 비워 종의 형체(빌 2:5–8).',difficulty:'쉬움'},
      {question:'바울이 “표 때를 향하여 달려간다”는 장은?',options:['1장','2장','3장','4장'],answer:2,explain:'상 주시는 부르심의 상을 향해(빌 3:14).',difficulty:'보통'},
      {question:'평강의 하나님이 주신다는 약속과 연결된 실천은?',options:['논쟁','염려','기도·간구·감사·바른 생각', '은둔'],answer:2,explain:'기도와 바른 생각의 실천(빌 4:6–9).',difficulty:'보통'},
      {question:'두 여인(유오디아·순두게)에게 권한 것은?',options:['경쟁','동일한 마음','분리','침묵'],answer:1,explain:'주 안에서 같은 마음을 품으라(빌 4:2).',difficulty:'보통'},
      {question:'바울이 기쁨을 명령형으로 권하는 장은?',options:['1장','2장','3장','4장'],answer:3,explain:'“주 안에서 기뻐하라… 다시 말하노니 기뻐하라”(빌 4:4).',difficulty:'쉬움'},
      {question:'바울의 재정에 대한 태도는?',options:['탐욕','자족','낭비','무시'],answer:1,explain:'있든 없든 자족을 배웠다고 고백합니다.',difficulty:'쉬움'},
      {question:'바울과 함께 보내려는 동역자로 언급된 이는?',options:['디모데','베드로','아볼로','디도'],answer:0,explain:'디모데를 보내려 합니다(빌 2:19).',difficulty:'보통'},
      {question:'빌립보서의 톤으로 가장 알맞은 것은?',options:['차갑고 교조적','따뜻하고 격려적','분노와 비난','법적 명령'],answer:1,explain:'감사와 격려, 기쁨의 어조가 지배합니다.',difficulty:'쉬움'},
      {question:'빌립보서의 핵심 적용은?',options:['세속적 성공','겸손·기쁨·복음 협력','권력 강화','율법 조항'],answer:1,explain:'공동체 안에서 겸손과 기쁨으로 복음을 협력.',difficulty:'보통'}
    ]
  },

  'col': {
    title:'골로세서',
    questions:[
      {question:'골로세서의 저자는?',options:['베드로','야고보','바울','요한'],answer:2,explain:'바울이 골로새 교회에 보낸 서신입니다.',difficulty:'쉬움'},
      {question:'골로세서의 중심 강조는?',options:['부와 번영','그리스도의 우월성과 충만','율법의 조항','천사 숭배'],answer:1,explain:'그리스도의 주권과 충분함을 선포합니다(골 1:15–20).',difficulty:'보통'},
      {question:'골로새 교회를 세우거나 섬긴 이는?',options:['디모데','에바브라','누가','아볼로'],answer:1,explain:'에바브라는 골로새를 위해 수고한 동역자입니다(골 1:7).',difficulty:'쉬움'},
      {question:'경계해야 할 것으로 바울이 경고한 것은?',options:['기도','감사','사람의 전통과 헛된 철학','찬양'],answer:2,explain:'그리스도를 빼는 철학·의식주의를 경계(골 2:8).',difficulty:'보통'},
      {question:'“위의 것을 생각하고”가 나오는 장은?',options:['1장','2장','3장','4장'],answer:2,explain:'위의 것을 생각하라(골 3:1–2).',difficulty:'쉬움'},
      {question:'“옛 사람 벗고 새 사람 입음”의 의미는?',options:['정치 개혁','도덕·정체성의 갱신','언어 교정','문화 수용'],answer:1,explain:'그리스도 안에서 새 정체성을 입는 변화(골 3:9–10).',difficulty:'보통'},
      {question:'가정 규범 중 남편에게 요구된 태도는?',options:['권위 남용','사랑','무관심','엄벌'],answer:1,explain:'남편들아 아내를 사랑하며 괴롭게 하지 말라(골 3:19).',difficulty:'쉬움'},
      {question:'기도에 대한 권면은?',options:['형식만 지킴','항상 깨어 감사함으로','침묵','타인 의존'],answer:1,explain:'기도에 항상 힘쓰며 감사함으로 깨어 있으라(골 4:2).',difficulty:'쉬움'},
      {question:'그리스도의 충만의 열매로 알맞지 않은 것은?',options:['겸손과 온유','사랑의 띠','탐욕','서로 용납'],answer:2,explain:'탐욕은 우상숭배로 버려야 할 것(골 3:5).',difficulty:'보통'},
      {question:'그리스도는 교회에 대해 어떤 위치인가?',options:['한 지도자','머리','회원','손님'],answer:1,explain:'그리스도는 교회의 머리이십니다(골 1:18).',difficulty:'쉬움'},
      {question:'천사 숭배에 대한 태도는?',options:['허용','권장','배격','무시'],answer:2,explain:'천사 숭배는 그리스도 중심에서 벗어나는 오류(골 2:18).',difficulty:'어려움'},
      {question:'말씀을 풍성히 거하게 하는 실천은?',options:['시기','시와 찬송과 신령한 노래','원망','세속 유행'],answer:1,explain:'감사함으로 마음에 거하게 하라(골 3:16).',difficulty:'쉬움'},
      {question:'밖에 있는 사람을 향한 행실은?',options:['지혜롭게 행하고 기회를 아끼라','무관심','논쟁만 하라','숨으라'],answer:0,explain:'지혜롭게 행하여 기회를 사라(골 4:5).',difficulty:'보통'},
      {question:'말을 할 때의 권면은?',options:['소금으로 맛을 냄과 같이 은혜로운 말','거친 말','중상','헛소리'],answer:0,explain:'각 사람에게 마땅히 대답할 말을 알게 하려 함(골 4:6).',difficulty:'보통'},
      {question:'옛 사람의 행위가 아닌 것은?',options:['분함/노여움','악의/비방','거짓말','사랑'],answer:3,explain:'사랑은 새 사람의 덕목입니다.',difficulty:'쉬움'},
      {question:'그리스도에 대한 바른 인식은?',options:['피조물 중 으뜸','보이지 아니하는 하나님의 형상','천사 중 하나','지혜자'],answer:1,explain:'창조와 화해의 주(골 1:15–20).',difficulty:'어려움'},
      {question:'골로세서에서 바울이 동역자로 언급하는 이와 거리가 먼 사람은?',options:['두기고','누가','데마','아히야'],answer:3,explain:'아히야는 본문과 무관. 두기고·누가·데마는 언급됩니다(골 4).',difficulty:'어려움'},
      {question:'“평강이 너희 마음을 주장하게 하라”와 연결된 태도는?',options:['분쟁','감사','의심','교만'],answer:1,explain:'감사로 충만하라(골 3:15).',difficulty:'쉬움'},
      {question:'골로세서의 경고 대상이 아닌 것은?',options:['헛된 철학','의식주의','율법주의','기도'],answer:3,explain:'기도는 권장 사항입니다.',difficulty:'쉬움'},
      {question:'골로세서의 핵심 적용은?',options:['그리스도 중심의 삶과 덕목 실천','부의 추구','권력 확대','은둔'],answer:0,explain:'모든 영역에서 그리스도 중심으로 살라.',difficulty:'보통'}
    ]
  },

  'phm': {
    title:'빌레몬서',
    questions:[
      {question:'빌레몬서의 수신자는?',options:['오네시모','빌레몬','누가','데마'],answer:1,explain:'빌레몬은 신실한 성도이자 가정 교회의 주인입니다.',difficulty:'쉬움'},
      {question:'오네시모의 원래 신분은?',options:['제사장','도망한 종','장군','세리'],answer:1,explain:'도망 종이었으나 회심 후 유익한 동역자가 됩니다.',difficulty:'쉬움'},
      {question:'바울이 빌레몬에게 간청한 핵심은?',options:['오네시모 처벌','오네시모를 형제로 받으라','오네시모 매각','오네시모 추방'],answer:1,explain:'종이 아닌 사랑받는 형제로 받으라(몬 1:16).',difficulty:'쉬움'},
      {question:'바울이 오네시모의 빚에 대해 한 말은?',options:['무시','내가 갚겠다','줄여 달라','법정 가자'],answer:1,explain:'바울이 대신 갚겠다고 합니다(몬 1:18–19).',difficulty:'보통'},
      {question:'서신의 톤으로 가장 가까운 것은?',options:['명령적·강압적','사랑의 간청·설득','차가움','법률문'],answer:1,explain:'권위보다는 사랑으로 호소합니다.',difficulty:'쉬움'},
      {question:'오네시모라는 이름의 의미와 서신의 메시지의 연결은?',options:['무익','유익','용감','충실'],answer:1,explain:'무익하던 자가 유익한 자로 변화됨을 상징합니다.',difficulty:'보통'},
      {question:'바울이 자신을 소개한 표현은?',options:['젊은 자','나이 많은 자이자 갇힌 자','왕','제사장'],answer:1,explain:'바울은 나이 많은 자, 갇힌 자로 자신을 낮춥니다.',difficulty:'보통'},
      {question:'빌레몬서의 길이는?',options:['긴 편지','복음서 분량','예언서 분량','한 장의 짧은 개인 서신'],answer:3,explain:'신약에서 매우 짧은 개인 서신입니다.',difficulty:'쉬움'},
      {question:'빌레몬서가 보여주는 복음의 능력은?',options:['법적 지식','관계의 화해와 회복','부의 증대','정치력'],answer:1,explain:'복음은 인간관계를 새롭게 합니다.',difficulty:'보통'},
      {question:'빌레몬서의 적용으로 옳은 것은?',options:['보복 권장','용서와 환대','배제','차별'],answer:1,explain:'형제로 환대하는 사랑이 핵심입니다.',difficulty:'쉬움'},
      {question:'바울이 공적 권위로 명령하기보다 택한 방식은?',options:['협박','은근한 개인적 권면','침묵','재판'],answer:1,explain:'자발성과 사랑을 존중합니다.',difficulty:'보통'},
      {question:'오네시모를 돌려보낸 이유와 맞는 것은?',options:['노동력 필요','법적 처리','공동체 유익과 화해','처벌'],answer:2,explain:'공동체의 유익과 복음적 화해를 위해.',difficulty:'보통'},
      {question:'바울의 리더십 스타일로 맞는 것은?',options:['강압적','중재적 사랑과 설득','회피','독선'],answer:1,explain:'사랑으로 설득하고 중재합니다.',difficulty:'보통'},
      {question:'빌레몬서와 거리가 먼 주제는?',options:['용서','형제애','화해','율법 조항 세부'],answer:3,explain:'율법 세부 논쟁은 중심 주제가 아닙니다.',difficulty:'쉬움'},
      {question:'오네시모를 “나의 아들”이라 부른 의미는?',options:['육신적 아들','영적 탄생과 관계', '종의 복귀','연줄'],answer:1,explain:'복음으로 낳은 영적 아들입니다(몬 1:10).',difficulty:'보통'},
      {question:'바울이 빌레몬의 순종을 확신한 근거는?',options:['강제력','법','그의 사랑과 신앙','두려움'],answer:2,explain:'빌레몬의 신앙과 사랑을 신뢰합니다.',difficulty:'보통'},
      {question:'동역자들 중 빌레몬서에 언급되는 인물이 아닌 것은?',options:['마가','아리스다고','데마','요압'],answer:3,explain:'요압은 구약 인물. 나머지는 언급됩니다(몬 1:24).',difficulty:'어려움'},
      {question:'바울이 머물 곳을 마련하라 한 요청은 무엇을 뜻하나?',options:['휴가','장기 체류','석방 후 방문 의사','이주'],answer:2,explain:'기도로 석방되어 방문할 소망을 표현(몬 1:22).',difficulty:'보통'},
      {question:'빌레몬서가 현대 그리스도인에게 주는 핵심 교훈은?',options:['법적 승리','관계의 복음적 재구성','권력 확대','은둔'],answer:1,explain:'복음은 억압적 관계를 형제애로 전환시킵니다.',difficulty:'보통'},
      {question:'빌레몬서의 문체적 특징은?',options:['공식적 칙령','개인적·따뜻한 간청의 편지','시가','설교문'],answer:1,explain:'개인적·설득적 문체가 돋보입니다.',difficulty:'쉬움'}
    ]
  }
};

/*****************
 * 저장 유틸
 *****************/
const LS_KEYS = {
  WRONG_NOTEBOOK: 'bq_wrong_notebook_ko',
  SESSION: 'bq_session_ko'
};
function setStateCookie(state){
  const data = encodeURIComponent(JSON.stringify({book: state.book, idx: state.idx, diff: state.diff, mode: state.mode}));
  document.cookie = `bq_state_ko=${data}; max-age=${60*60*24*14}; path=/`;
}
function getStateCookie(){
  const m = document.cookie.match(/(?:^|; )bq_state_ko=([^;]+)/);
  if(!m) return null; try { return JSON.parse(decodeURIComponent(m[1])); } catch { return null; }
}
function saveSession(obj){ localStorage.setItem(LS_KEYS.SESSION, JSON.stringify(obj)); }
function loadSession(){ const s = localStorage.getItem(LS_KEYS.SESSION); return s? JSON.parse(s): null; }
function saveWrong(bookKey, record){
  const raw = localStorage.getItem(LS_KEYS.WRONG_NOTEBOOK);
  const map = raw? JSON.parse(raw): {};
  map[bookKey] = map[bookKey] || [];
  map[bookKey].push(record);
  localStorage.setItem(LS_KEYS.WRONG_NOTEBOOK, JSON.stringify(map));
}
function getWrongMap(){ const raw = localStorage.getItem(LS_KEYS.WRONG_NOTEBOOK); return raw? JSON.parse(raw): {}; }
function clearWrong(bookKey){
  const raw = localStorage.getItem(LS_KEYS.WRONG_NOTEBOOK);
  if(!raw) return; const map = JSON.parse(raw); delete map[bookKey];
  localStorage.setItem(LS_KEYS.WRONG_NOTEBOOK, JSON.stringify(map));
}

/*****************
 * UI 요소
 *****************/
const bookSelect = document.getElementById('bookSelect');
const diffSelect = document.getElementById('diffSelect');
const modeSelect = document.getElementById('modeSelect');
const startBtn = document.getElementById('startBtn');
const resumeBtn = document.getElementById('resumeBtn');

const introSec = document.getElementById('intro');
const introTitle = document.getElementById('introTitle');
const introMeta = document.getElementById('introMeta');
const introBody = document.getElementById('introBody');

const quizArea = document.getElementById('quizArea');
const bookTitleEl = document.getElementById('bookTitle');
const progressEl = document.getElementById('progress');
const diffPill = document.getElementById('diffPill');
const qCard = document.getElementById('qCard');
const explainBox = document.getElementById('explainBox');
const nextBtn = document.getElementById('nextBtn');
const quitBtn = document.getElementById('quitBtn');

const resultArea = document.getElementById('resultArea');
const finalScore = document.getElementById('finalScore');
const finalMsg = document.getElementById('finalMsg');
const reviewBtn = document.getElementById('reviewBtn');
const restartBtn = document.getElementById('restartBtn');

const reviewArea = document.getElementById('reviewArea');
const reviewList = document.getElementById('reviewList');
const closeReviewBtn = document.getElementById('closeReviewBtn');
const exportWrongBtn = document.getElementById('exportWrongBtn');
const retryWrongBtn = document.getElementById('retryWrongBtn');
const clearWrongBtn = document.getElementById('clearWrongBtn');

/*****************
 * 상태
 *****************/
let state = {
  bookKey:null, questions:[], idx:0, score:0,
  mode:'normal', diff:'all',
  answersRecord:[]
};

/*****************
 * 서론 표시
 *****************/
bookSelect.addEventListener('change', renderIntro);
function renderIntro(){
  const k = bookSelect.value; if(!k){ introSec.classList.add('hidden'); return; }
  const intro = bookIntros[k]; if(!intro){ introSec.classList.add('hidden'); return; }
  introTitle.textContent = intro.title + ' — 서론';
  introMeta.textContent = intro.meta;
  introBody.innerHTML = `
    <div class="mb-2"><span class="font-semibold">배경:</span> ${escapeHtml(intro.background)}</div>
    <div class="mb-2"><span class="font-semibold">줄거리:</span> ${escapeHtml(intro.summary)}</div>
    <div class="mb-1 font-semibold">중요 인물:</div>
    <ul class="list-disc pl-5 text-sm text-gray-700">
      ${intro.characters.map(c=>`<li><span class="font-medium">${escapeHtml(c.name)}</span>: ${escapeHtml(c.note)}</li>`).join('')}
    </ul>`;
  introSec.classList.remove('hidden');
}

/*****************
 * 시작/이어하기
 *****************/
startBtn.addEventListener('click', ()=>{
  const key = bookSelect.value; if(!key) return alert('먼저 책을 선택하세요.');
  const diff = diffSelect.value; const mode = modeSelect.value;
  startQuiz({key,diff,mode});
});
resumeBtn.addEventListener('click', ()=>{
  const ck = getStateCookie(); const ss = loadSession();
  if(!ck || !ss) return alert('저장된 진행이 없습니다.');
  state = ss;
  if(!booksData[state.bookKey]) return alert('책 데이터가 없습니다.');
  bookTitleEl.textContent = booksData[state.bookKey].title;
  diffPill.textContent = labelForDiff(state.diff);
  document.getElementById('selector').scrollIntoView({behavior:'smooth'});
  quizArea.classList.remove('hidden'); resultArea.classList.add('hidden'); reviewArea.classList.add('hidden');
  renderQuestion();
});
function startQuiz({key,diff,mode}){
  state.bookKey=key; state.diff=diff; state.mode=mode; state.idx=0; state.score=0; state.answersRecord=[];
  const allQ = booksData[key].questions.slice();
  if(mode==='wrongonly'){
    const wrongMap = getWrongMap(); const arr=(wrongMap[key]||[]).map(r=>({...r.original}));
    if(arr.length===0){ alert('해당 책의 오답 노트가 비어 있습니다.'); return; }
    state.questions = arr;
  }else{
    const filtered = (diff==='all')? allQ : allQ.filter(q=> (q.difficulty||'쉬움')===koDiff(diff));
    state.questions = shuffle(filtered);
  }
  if(state.questions.length===0){ alert('해당 선택에서 문제를 찾지 못했습니다.'); return; }
  bookTitleEl.textContent = booksData[key].title;
  diffPill.textContent = labelForDiff(diff);
  quizArea.classList.remove('hidden'); resultArea.classList.add('hidden'); reviewArea.classList.add('hidden');
  renderQuestion();
}
function koDiff(d){ return d==='easy'?'쉬움': d==='medium'?'보통': d==='hard'?'어려움': d; }

/*****************
 * 렌더/채점
 *****************/
function renderQuestion(){
  const q = state.questions[state.idx];
  explainBox.classList.add('hidden'); explainBox.innerHTML=''; nextBtn.disabled=true;
  progressEl.textContent = `${state.idx+1} / ${state.questions.length}`;
  qCard.innerHTML = `
    <div class="flex items-center justify-between mb-2">
      <div class="text-base font-semibold">${state.idx+1}. ${escapeHtml(q.question)}</div>
      <span class="chip ${diffClass(q.difficulty)}">${escapeHtml(q.difficulty||'쉬움')}</span>
    </div>
    <div class="space-y-2">
      ${q.options.map((opt,i)=>`
        <button class="opt-btn w-full text-left border border-gray-200 rounded-lg opt hover:bg-blue-50 transition" data-i="${i}">
          <div class="px-3"><span class="text-xs text-gray-500 mr-1">${String.fromCharCode(65+i)}.</span> ${escapeHtml(opt)}</div>
        </button>
      `).join('')}
    </div>`;
  Array.from(qCard.querySelectorAll('.opt')).forEach(btn=>btn.addEventListener('click', onSelect));
  setStateCookie({book:state.bookKey, idx:state.idx, diff:state.diff, mode:state.mode});
  saveSession(state);
}
function onSelect(e){
  const btn=e.currentTarget; const sel=parseInt(btn.getAttribute('data-i'));
  const q=state.questions[state.idx]; const correct=(sel===q.answer);
  if(correct) state.score++;
  state.answersRecord.push({q:q.question, options:q.options.slice(), answer:q.answer, user:sel, correct, explain:q.explain, difficulty:q.difficulty||'쉬움'});
  Array.from(qCard.querySelectorAll('.opt')).forEach(b=>{
    b.disabled=true; b.classList.add('opacity-80');
    const i=parseInt(b.getAttribute('data-i'));
    if(i===q.answer){ b.classList.add('border-2','border-green-300','bg-green-50'); }
    if(i===sel && i!==q.answer){ b.classList.add('border-2','border-red-300','bg-red-50'); }
  });
  explainBox.innerHTML = `<div class="font-medium mb-1">${correct?'정답입니다 🎉':'아쉽습니다 ✖️'}</div><div class="text-sm">${escapeHtml(q.explain||'')}</div>`;
  explainBox.classList.remove('hidden');
  nextBtn.disabled=false;
  if(!correct){ saveWrong(state.bookKey, {original:q, picked:sel, at:Date.now()}); }
  saveSession(state);
}
nextBtn.addEventListener('click', ()=>{
  if(state.idx<state.questions.length-1){ state.idx++; renderQuestion(); window.scrollTo({top:0,behavior:'smooth'}); }
  else{ showResult(); }
});
quitBtn.addEventListener('click', ()=>{ if(confirm('퀴즈를 종료하고 처음으로 돌아갈까요?')) location.reload(); });

/*****************
 * 결과/리뷰
 *****************/
function showResult(){
  quizArea.classList.add('hidden'); resultArea.classList.remove('hidden');
  const total=state.questions.length; const pct=Math.round(state.score/total*100);
  finalScore.textContent = `점수: ${state.score} / ${total} (${pct}%)`;
  finalMsg.textContent = pct===100?'완벽합니다!': pct>=80?'아주 좋아요!': pct>=50?'좋아요. 해설을 읽고 한 번 더!':'해설을 보며 오답을 다시 풀어보세요.';
  saveSession(state);
}
reviewBtn.addEventListener('click', ()=>{ resultArea.classList.add('hidden'); reviewArea.classList.remove('hidden'); renderReview(); });
restartBtn.addEventListener('click', ()=> location.reload());
closeReviewBtn.addEventListener('click', ()=>{ reviewArea.classList.add('hidden'); resultArea.classList.remove('hidden'); });
function renderReview(){
  reviewList.innerHTML='';
  state.answersRecord.forEach((r,idx)=>{
    const userOpt = r.user!=null ? String.fromCharCode(65+r.user) : '(무응답)';
    const correctOpt = String.fromCharCode(65+r.answer);
    const div=document.createElement('div'); div.className='p-3 border border-gray-100 rounded-lg';
    div.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="font-medium mb-1">${idx+1}. ${escapeHtml(r.q)}</div>
        <span class="chip ${diffClass(r.difficulty)}">${escapeHtml(r.difficulty)}</span>
      </div>
      <div class="text-sm text-gray-700 mb-2">
        내 답: <span class="${r.correct?'text-green-600 font-semibold':'text-red-600 font-semibold'}">${escapeHtml(userOpt)}</span>
        &nbsp; 정답: <span class="font-semibold">${escapeHtml(correctOpt)}</span>
      </div>
      <div class="text-sm text-gray-700">${escapeHtml(r.explain||'')}</div>`;
    reviewList.appendChild(div);
  });
}
retryWrongBtn.addEventListener('click', ()=>{
  const k=state.bookKey; const map=getWrongMap(); const wrongArr=(map[k]||[]).map(r=>({...r.original}));
  if(wrongArr.length===0){ alert('오답 노트가 비어 있습니다.'); return; }
  state.mode='wrongonly'; state.idx=0; state.score=0; state.answersRecord=[]; state.questions=shuffle(wrongArr);
  reviewArea.classList.add('hidden'); quizArea.classList.remove('hidden'); renderQuestion();
});
clearWrongBtn.addEventListener('click', ()=>{ if(confirm('이 책의 오답 노트를 비울까요?')){ clearWrong(state.bookKey); alert('오답 노트를 삭제했습니다.'); } });
exportWrongBtn.addEventListener('click', ()=>{
  const k=state.bookKey; const map=getWrongMap();
  const rows=(map[k]||[]).map(x=>({question:x.original.question, options:x.original.options, answer:x.original.answer, picked:x.picked}));
  const blob=new Blob([JSON.stringify(rows,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${k}-wrong-notebook.json`; a.click(); URL.revokeObjectURL(a.href);
});

/*****************
 * 헬퍼
 *****************/
function shuffle(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
function labelForDiff(d){ return d==='all'?'전체': d==='easy'?'쉬움': d==='medium'?'보통': d==='hard'?'어려움':'전체'; }
function diffClass(d){ switch(d){ case '쉬움': return 'bg-green-50 border-green-200 text-green-700'; case '보통': return 'bg-amber-50 border-amber-200 text-amber-700'; case '어려움': return 'bg-red-50 border-red-200 text-red-700'; default: return 'bg-slate-50 border-slate-200 text-slate-700'; } }
function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
</script>
</body>
</html>
